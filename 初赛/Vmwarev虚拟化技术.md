#VMware虚拟化技术
>本文包括：

>1、服务器虚拟化

>2、VMware组件

>3、ESXi介绍

>4、vCenter Server

>5、VMware虚拟机及虚拟机管理

>6、VMware vMotion及Storage vMotion

>7、VMware可用性和可扩展性

- 虚拟化是一种资源管理技术，将计算机的物理资源，如服务器、网络、内存及存储等，抽象转换后呈现出来，打破物理设备结构间不可分割的障碍，这些资源不受现有的架构约束
- 虚拟化创建了一层隔离层，把硬件和上层应用分离开来，允许在一个硬件资源上运行多个逻辑应用
- 常见的虚拟化
	- 内存虚拟化：Page File
	- 磁盘虚拟化：RAID，Volume
	- 网络虚拟化：VLAN
- VMware实现的是X86服务器的虚拟化，包含以下三个方面
	- 计算能力：CPU/Memory的虚拟化
	- 存储：VMFS文件系统
	- 网络：虚拟交换机
##1、服务器虚拟化
- 虚拟基础架构
	- 物理主机-虚拟化层-虚拟机

- 一台物理主机上可以运行多个虚拟机，每台虚拟机之间互不影响，可以是不同的OS

- 资源共享
	- 虚拟化层将物理主机的资源共享给虚拟机

- CPU虚拟化
	- 超线程技术和CPU虚拟化可以提供CPU过量使用，如物理主机只有4颗CPU，虚拟机共有7颗CPU

- 内存
	- 内存复用和内存压缩，主机只有8G，但是虚拟机可以有10G
	- VMkernel控制物理内存
	- 每个虚拟机拥有独立的连续可寻址的虚拟内存空间
	- 物理内存不足时可以使用磁盘存储作为交换空间
- 网络
	- 虚拟交换机：连接物理网卡与虚拟网卡
	- 虚拟网卡：虚拟机中运行的网卡，对外进行网络通讯
	
- 存储虚拟化
	- 通过虚拟磁盘vmdk文件的封装实现
		- 多个ESXi主机访问共享存储
		- 虚拟机的文件系统对ESXi主机是不可见的

##2、VMware组件
- ESXi
	- 协调物理计算机资源
	- 通过配置vSwitch管理网络资源
	- 通过NFS管理存储资源

- vCenter Server
	- 将每台主机虚拟化，即安装ESXi
	- 根据业务分群
	- 提供集中管理接口，供管理员管理整套虚拟环境
	- 实现虚拟化高级功能，如虚拟迁移，如分布式服务
	- 统一身份验证，提供了统一的接口

- VMware Vsphere Client
	- 客户端管理工具
	- 为管理员提供图形化管理界面

- vSphere Update Manager	
	- 更新管理

- VMware Data Protection	
	- 基于存储的数据备份保护
	- 块跟踪

- vRealize Orchetrator 
	- 自动化，迁移数据

- vCloud center
	- 适合私有云发布云环境

##3、ESXi介绍
- 虚拟化前
	- 软件必须与硬件相结合
	- 每台机器只能运行单一的OS
	- 每个OS有一个或多个应用程序负载（通常只有一个）

- 虚拟化后
	- 增加虚拟化层
	- 每台机器上有多个OS和多个应用负载

- ESX发展过程
	- GSX
		- 作为应用程序安装
		- 在主机OS上运行
		- 依赖OS进行资源管理
		- 兼容性好
		- 性能差，功能单一
		- 称之为**寄居式虚拟化**，
	
	- ESX
		- 裸机安装
		- **裸金属虚拟化**
		- 将虚拟化程序写入Linux OS中，不完全是裸的
		- 非虚拟化进程会
		- 脚本和代理，不方便
	
	- ESXi（当前应用最广泛的的版本）也称为Hypervisor
		- 裸机安装
		- 移除了所有Linux的东西
		- 减少了虚拟化层对物理层的开销
		- 对硬件兼容性要求高
		- 管理任务已从虚拟化管理程序中移除
		- ESXi独立于通用OS运行，简化了虚拟环境
		- 精简体系结构，
		- 更小的安全占用空间
		- 简化的部署和配置

- ESXi体系结构
	- VMkernel统一管理程序 
	- 可以使用 vcenter server 或者 vsphere client
	
##4、vCenter Server
- 充当ESXi主机及其虚拟机中心管理点的服务
- 供管理员统一的管理企业虚拟化环境
- 提供集中管理接口
- 实现虚拟化高级功能
	- 虚拟机迁移的vMotion
	- 虚拟机模板、虚拟机克隆
	- 分布式虚拟交换机

- vCenter通过vpxa代理，再通过host服务管理主机
	- 资源管理
	- 模板管理
	- 虚拟机管理
	- 安全
	- 日志

##5、VMware虚拟机及虚拟机管理
- 虚拟机
	- 一个可在其上运行受支持的客户OS和应用程序的虚拟硬件集
	- 一组离散的文件
		- 配置
		- 交换
		- BIOS
		- 日志
		- 虚拟磁盘（最重要）

- 虚拟机模板
	- 通常包含一个客户OS，一个应用程序和特定d虚拟机配置映像

- 管理模板
	- 克隆模板，虚拟机可开启
	- 转为模板，虚拟机必须为关闭

- 动态增加磁盘大小

- 虚拟机快照：虚拟机某一时间点的状态（磁盘状态、BIOS及配置状态、内存状态）
	- 相恢复快照数据时，增量磁盘把数据给当前磁盘中
	- 当恢复磁盘时，清除增量磁盘
	- 临时容错方案，不能替代备份！
	- 当虚拟机数据损坏，快照不能恢复
	- 为防止增量磁盘太大，要及时清除快照

##6、VMware vMotion及Storage vMotion
- 虚拟机迁移方式
- 迁移：将虚拟机从一台主机或数据存储移动到另一台主机或数据存储
	- 冷迁移：虚拟机电源关闭，不跨数据中心，不需要共享数据，允许使用不同系列的CPU
	- 挂起迁移：虚拟机挂起，不跨数据中心，不需要共享数据，必须满足CPU兼容性要求
	- 迁移主机vMotion：虚拟机电源开启，跨数据中心，需要共享数据，必须满足CPU兼容性要求
	- 迁移存储Storage vMotion：虚拟机电源开启，跨数据中心，不需要共享数据，不需要考虑CPU

- vMotion：虚拟机开机时，将虚拟机从一个主机在线迁移到另一个主机
	- 提高整体硬件利用率
	- 使虚拟机在计划内硬件停机期间能够继续运行
	- 实现跨主机平衡虚拟机负载
	- vMotion：动态迁移，服务不中断，零宕机时间，支持SAN、ISCSI、NAS
	- 要求：
		- 虚拟机不能与内部交换机连接
		- 内部交换机不连接任何物理网卡
		- 虚拟机不能与装载了本地映像的虚拟机连接

- Storage vMotion：虚拟机开机时，将虚拟机从一个存储在线迁移到另一个存储
	- 存储维护和重新分配
	- 重新分配存储负载
	- 清除即将淘汰的存储
	- 执行存储分层
	- 源与目标的存储类型可以不同！NAS到SAN或本地，本地到ISCSI
	- 非高峰时期迁移

- Cross Host vMotion（无共享存储vMotion
	- 不可跨越虚拟数据中心
	- 同时迁移主机与存储
##7、VMware可用性和可扩展性
- VMware各级容灾方案
	- 站点级别：Site Recovery Manager
	- 数据级别：VMware Data Recovery 以及其他第三方解决方案
	- 存储级别：Storage vMotion
	- 服务器级别：vMotion，DRS
	- 组件级别：网卡绑定，存储多路径功能

- VMware实现高可用性的办法——vSphere HA（High Availability）
	- 宕机时间在分钟级别
	- 内存数据丢失
	- 支持一切OS
	- 支持所有ESXi硬件
	- 功能：当ESXi服务器故障时，自动重新启动虚拟机，ESXi服务器级别
	- 可在发生以下故障时提供保护
		- ESXi主机故障
		- 虚拟机或客户OS故障
		- 应用程序故障
	- 优势：**经济有效，不需要独占硬件，没有集群软件的复杂性**
- FT（Fault Tolerance）应用——
	- 基于HA，比HA更高的业务连续性，更易实现，更高级别
	- 没有重启，没有数据丢失，没有宕机时间实现应用程序的零停机和零数据丢失
	- 创建一个热备虚拟机，与原虚拟机状态相同，但是一般不对外提供服务，虚拟机级别

- DRS（Distributed Resource Scheduler）
	- 动态负载均衡和连续智能优化，保证所有应用需要的资源
	- **围绕应用业务进行组织和规划，而不是硬件！**
	- 比如：运行核心业务的虚拟机所属的物理主机把其他虚拟机动态迁移到其他物理主机上，利用vMotion迁移技术
	- 当有新的主机加入DRS集群时，自动分配一些虚拟机到新主机
	- 优点：
		- 自动化管理操作，减少管理开销
		- 快捷响应业务的变化
		- 通过自动均衡负载，提供可控的服务级别

	- 最佳实践：在大型的虚拟化环境中，将DRS打开，并放置于全自动状态

##test
		[对]在 VMware 中部署虚拟机，将虚拟机克隆为模板时虚拟机既可处于开启状态，也可处于关闭状态。将虚拟机转换为模板时虚拟机必须处于关闭状态。
		
		配置 HA 群集时，有时会发现群集中的个别主机提示，隔离地址不可达或者不具有隔离地址，出现这种警告的原因是什么？C
		
		   A  HA 群集中的共享存储数量少于 2 个
		   B  HA 群集创建过程中选择了 EVC 模式
		   C  未设置网关后者网关地址不是真实地址，或者手动设定了不正确的隔离地址
		   D  HA 群集中主机间做了网络隔离，使得该问题主机和其他主机无法通信
		
		服务器虚拟化中，同一台物理计算机上运行的虚拟机，当其中一台崩溃或者修改时，不影响其他虚拟机的运行状态，这体现了虚拟化的什么特性？B
		
		   A  兼容性
		   B  隔离性
		   C  独立于硬件
		   D  统一性
		
		下列 vSphere 组件中，哪一个组件可用于为每台虚拟机创建辅助虚拟机，以便在虚拟机出现故障时可由辅助虚拟机取代故障虚拟机？C
		
		   A  Data Protection
		   B  Distributed Resources Scheduler
		   C  Fault Tolerance
		   D  High Availability
		
		迁移虚拟机的方法有很多种，请在下列各种方法中，选出迁移过程中源主机和目标主机必须满足 CPU 兼容性需求的方法？CD
		
		   A  Storage vMotion
		   B  冷迁移（关机后迁移）
		   C  vMotion
		   D  挂起后迁移