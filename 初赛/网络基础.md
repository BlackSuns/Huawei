#网络基础
>本文包括：

>1、IP 路由技术描述

>2、IPv6技术描述

>3、VLAN（虚拟局域网）技术

>4、QoS

>5、NAT技术

>6、NE路由器日常维护

>7、以太网链路聚合

>8、OSPF协议

##1、IP 路由技术描述
- 路由是指导IP报文发送的路径信息

- 路由表
	- 目的地址
	- 协议类型
	- Preference值
	- Cost值
	- 下一跳地址
	- 出接口

- 路由器关键功能
	- 检查数据包的目的地
	- 确定信息员
	- 发现可能的路由
	- 选择最佳路由
	- 验证和维护路由信息

- 直连路由
	- 在路由表中显示为direct

- 静态路由
	- 适用于网络拓扑非常简单的路由
	- 在路由表中显示为static
	- 一般网络拓扑比较复杂，若用静态路由，不利于后期维护
	- 可以配置备份路由，把优先级设低，刚开始不加入路由表中，当主用链路断开时，备份路由自动变为主动，并加入到路由表中

- 静态路由与动态路由
	- 静态路由
		- 由网络管理员手工指定的路由
		- 当网络拓扑发生变化时，管理员需要手工更新静态路由
	- 动态路由
		- 路由器使用路由协议从其他路由器那里获悉的路由

		- 当网络拓扑发生变化时，路由器会更新路由信息

- 缺省路由
	- 特殊的路由，可以通过静态路由配置，某些动态协议如OSPF或ISIS也可以生成缺省路由
	- 在路由表中，缺省路由以到网络0.0.0.0（掩码为0.0.0.0）的路由形式出现
	- 当路由器收到一个目的地在路由表中查找不到的数据包时，会将数据包转发给缺省路由指向的下一跳

###路由协议
- 路由协议是路由器之间交互信息的一种语言，路由器之间通过路由协议共享网络状态和网络可达性的一些信息
- 相互通信的双方必须使用同一种语言才能交互路由信息
- 路由协议定义了一套路由器之间通信时适用的规则
- 路由协议维护路由表、提供最佳转发路径

- 路由协议的分类（动态）
	- 按作用范围分类
		- IGP（内部网关协议）
			- OSPF
			- ISIS
			- RIP（很少用）
		- EGP（外部网关协议）
			- BGP
	- 按路由协议算法分类
		- 距离矢量算法协议：逐跳的报文转发
			- BGP：称为路径矢量协议，Path-Vector
			- RIP
		- 链路状态算法协议：邻居和邻接关系建立，泛洪LSA（链路状态信息），生成链路状态数据库，根据SPF（最短路径优先）算法，生成最短路径树，再根据最短路径树得到下一跳路径
			- OSPF
			- ISIS
	- 按业务应用分类
		- 单播路由协议
		- 组播路由协议

- 动态路由协议的应用
	- 城域网和骨干网路由协议的部署：城域网（MAN）用OSPF，骨干网用ISIS，两者连接用BGP
	- IP承载网：ISIS

- 衡量路由协议的一些性能指标
	- 正确性
	- 快收敛
	- 低开销
	- 安全性
	- 普适性
###路由技术介绍
- 引入路由
	- 在本路由器的路由表中查询，如果发现要引入的路由（如static），则作为自己已知的路由发布出去

- 路由优先级（Preference）
	- 存在多个路由来源时，具有较高优先级（数值越小表明优先级越高）的路由来源提供的路由将被激活，用于指导报文的转发
	- VRP缺省的路由优先级如下所示：
		- DIRECT:0
		- OSPF:10
		- ISIS:15
		- STATIC:60
		- RIP:100
		- OSPF ASE:150
		- IBGP:255
		- EBGP:255
		- UNTRUSTWORTHY:255

- 路由的花费
	- 路由器优先选较小花费值的路由，并加到路由表中

- 等价路由：ECMP（Equal Cost Multi-Path）
	- 到同一个目的地由几条相同花费的路由，当路由优先级相同时，它们都会被加入到路由表中，IP包会在这几个链路上负载分担

- 最长匹配原则
	- 查找路由表
	- 目的地址与掩码分别做“与”操作
	- 与路由表中的目的地址做比较
	- 挑选出最长匹配项

- 路由环路（Routing LOOP）
	- 报文在两个或几个路由器之间循环路由，直到TTL减为0而丢弃
	- TTL：指一个数据包在经过一个网络时，可传递的最长距离（跃点数）。每当数据包经过一个路由器时，其存活时间就会被减一。当其存活时间为 0 时，路由器便会取消数据包并发送一个 ICMP TTL 数据包给原数据包的发出者。其设计目的是防止数据包因不正确的路由表等原因造成的无限循环而无法送达及耗尽网络资源。

##2、IPv6技术描述
- IPv4与IPv6
	- IPv4，2的32次方，大概43亿个IP地址，然而需要570亿个IP地址，这570亿个IP地址分为三类
		- Home Network
		- Mobile
		- M2M（Machine to Machine）
	- IPv6，2的128次方

- IPv6格式
	- IPv6地址 = 前缀（前64位） + 接口标识（后64位）
		- 前缀：相当于v4地址中的网络ID
			- 本地链路地址（不上因特网）：fe80开头
			- 公网地址（全球单播地址）：2001开头
		- 接口标识：相当于v4地址中的主机ID
	- 首选格式：	用十六进制标识，如 FE80
		- 2001:0410:0000:0001:0000:0000:0000:45ff/64
	- 压缩格式：若以零开头可以省略；连续全零的组可用“::”表示，但是一个IPv6地址中“::”只能出现一次
		- 2001:410:0:1::45ff/64

- IPv6的地址结构与地址分类
	- IPv4的地址分类
		- 单播地址
		- 组播地址
		- 广播地址

	- IPv6的地址分类
		- 单播地址（使用最多）：标识一个接口，目的为单播地址的报文会被送到被标识的接口
		- 组播地址：标识多个接口，目的为组播地址的报文将会被送到被标识的所有接口
		- 任意播地址：标识多个接口，目的为任意播地址的报文会被送到最近的一个标识接口

	- IPv6单播地址分类
		- 未指定地址：全0地址 ::，标识自己，如同IPv4中的127.0.0.1
		- 回环地址： ::1
		- 全球单播地址： 2001:1304:6101:1:E0:F726:4E58
		- 内嵌IPv4地址的IPv6地址： ::10.153.70.200
		- 本地链路地址： FE80::E0:F726:4E58


##3、VLAN（虚拟局域网）技术
- 背景
	- 以太网交换机在转发数据时，采用源地址学习的方式，自动学习各个端口连接的主机的MAC地址，形成转发表，缺少转发控制的手段
	- 缺点：
		- 网络的安全性很差：任意端口可以互相转发
		- 网络效率低
		- 业务扩展能力差
	- VLAN：把传统的以太网分为多个逻辑的网络组，组内可以通信，组件不允许通信
		- 抑制大量广播报文
		- 利于管理与维护

- 标签
	- 打标签，在交换机检查标签，隔离组与组间的通信

- 应用规则
	- VLAN分为3个端口
		- **ACCESS端口：交换机用来连接用户的主机的端口**
			- 接受时：从主机出来的数据帧是标准的以太网帧，不带标签（Untagged），到达交换机后，会打上PVID标签（由管理员配置的PVID）
			- 发送时：发往主机，所以会把PVID剥离掉（如果数据帧的PVID与当前ACCESS端口配置的PVID不一致，则丢弃该帧）
		- **TRUNK端口：交换机用来和其他交换机连接的端口**
			- 接受时：如果数据帧不带VLANID，则打上一个VLANID，如果数据帧带VLANID，则不处理原封不动地收进来
			- 发送时：如果数据帧打的PVID与该端口对应的VLANID对应，则剥离该PVID标签成为标准的以太网帧；如果PVID与VLANID不对应，则不处理原封不动地发出去
		- **HYBRID端口：连接用户主机又可以连接其他交换机**
			- 允许多个VLAN帧通过，
			- 接受时：如果数据帧的PVID等于对应VLAN，剥离标签成为一个标准的以太网帧；如果PVID与VLANID不对应，则不处理；
			- 发送时：如果数据帧的PVID等于对应VLAN，剥离标签成为一个标准的以太网帧

		- HYBRID与TRUNK接受时一样的
		- HYBRID与TRUNK发送时不一样，TRUNK只能处理一个VLAN值，HYBRID可以处理多个VLAN值
	- 在主机发出的数据包，通过ACCESS端口时，会被打上PVID标签，

##4、QoS
- 流量分类
	
	- 语音或VPN业务
	
	- 视频业务
	
	- 上网业务

- 衡量QoS的指标
	- 带宽
		- 最大带宽取决于传输路径的最小带宽（短板效应）
	- 时延
	- 抖动
	- 丢包

- 如何提高质量
	
	- 更强的设备处理能力
	
	- 更大链路带宽
	
	- 合理的队列调度和拥塞避免机制(QoS）

- 服务模型
	
	- 尽最大努力服务模型
	
	- 集中服务模型
	
	- 区分服务模型

- 分类
	- 复杂流分类：采用复杂的规则
	- 简单流：根据已经指定好的优先级
	- 一般同时使用，网络边缘用复杂流分类

- 流量的管理
	- 流量监管
		- 令牌桶，维持一定速率的放置令牌，如果没有令牌了，则
		- 对丢包率不敏感，不会增加时延
	- 流量整形
		- 对没有令牌的流量先缓存起来，等网络空闲了再转发
		- 减小丢包率，但是会增加时延

- 队列调度机制
	- FIFO：先进先处
		- 高优先级和低优先级都是按到达顺序来排队的
	- PQ（Strict Priority）
		- 高优先级的报文网络时延会降低
		- 缺点：当高优先级的报文太多时，低优先级报文不能转发（扼死）
	- WFQ（Weighted Fair Queuing）：加权公平队列
		- 根据优先级分配带宽
		- 使得带宽分配更加公平
	- 一般PQ和WFQ一起使用，如语音业务会由PQ

	- WRED：加权随机早期检测丢弃
		- 当报文开始排队时，就已经开始丢弃报文了
		- 低优先级的报文被丢弃的概率打
		- 保证报文队列不会饱满

- QoS实现
	- 流分类
	- 流行为
	- 流量策略
	- 策略应用

##5、NAT技术
- IP地址分类
	- 私有地址
	- 公网地址

- 公网用户没法访问私网服务器

- NAT session 
	- 在网络地址转换时设备会对报文转换前的源IP地址以及端口号和转换以后的源IP地址以及端口号的对应关系做的记录

- 一般，一个私网用户对应一个公网地址，但公网地址是稀缺的，所以出现了NAPT技术
- NAPT	
	- 指在进行NAT转换IP地址的同时，还对端口号进行转换，这种应用可以实现多个私网用户共有一个公网地址

- NAT SERVER
	- 管理员手动设置
	- 私网服务器转换为公网服务器地址以及端口号
	- 外网用户访问的地址是转换后的公网服务器地址

- NAT ALG应用层网关
	- 通过对应用层协议的协商报文部分的分析，在双方的新通道建立之前，就提前获取到相关信息，并为其自动建立相应的NAT转换规则
	- 并不是支持所有协议

##6、NE路由器日常维护
- 5个例行维护项目
	- 机房环境
		- 温度
			- 长期：0-45度
			- 短期允许：-5 ~55
		- 湿度
			- 长期：5%~85%
			- 短期允许：0~95%
	- 设备环境
		- 设备温度
			- 查看设备各单板的温度
			- display temperature
		- 设备电压
			- 查看设备各单板的电压
			- display voltage
	- 日志和告警
		- 有异常及时上报
		- 日志
			- display logbuffer
		- 告警
			- display trapbuffer
	- 设备运行环境
		- 单板运行状态
			- display device
				- online=present
				- register=registered
				- status=normal
		- 电源状态
			- display power
				- status=normal
		- 风扇状态
			- display fan 
				- status=normal
		- CPU占用情况
			- 一般不超过80%
			- display cpuusage
	- 业务运行环境
		- OSPF邻居状态
			- display ospf peer
				- status=full
		- ISIS邻居状态
			- display isis peer
				- status=up
		- BGP邻居状态
			- display bgp peer
				- status=established
		- 路由信息
			- 正常情况下要检查默认路由是否存在
			- display ip routing-table
		- 配置文件
			- display current-configuration
			- display saved-configuration
		- 主备板配置文件
			- display startup
		- PAF、License信息
			- dir
		- 补丁信息
			- display patch-information
			
- NE系列路由器维护操作指导
	- 防尘网：为散热进风提供灰尘过滤，为了保证系统散热和通风状况，建设至少3各月定期清洗一次
		- 注意要戴防静电手套、防静电护腕
		- 吸尘器、拍打、刷子

	- 备份配置文件
		- display current-configuration
		- 经常拷贝所有显示信息到TXT文本信息中


##7、以太网链路聚合
- 链路聚合（Link Aggregation）也叫做端口捆绑、端口距今或链路聚集，链路聚集是将多个端口聚合在一起形成一个汇聚组，以实现出入符合在各成员端口中的分担，从外面看，一个汇聚组就好像一个端口
- 使用链路聚合的上层实体把统一聚合组内多条物理链路视为一条逻辑链路
- 链路聚合在数据链路层上实现

- 链路聚合的优点
	- 提高链路带宽
	- 流量符合分担
	- 提高可靠性：同组成员彼此动态备份

- 链路聚合的限制条件
	- 聚合链路两端的物理参数必须保持一致
		- 进行聚合的链路的数目
		- 进行聚合的链路的速率
		- 进行聚合的链路的双工方式
	- 聚合链路两端的逻辑参数必须保持一致
		- 同一个汇聚组中断藕的基本配置必须保持一致，基本配置主要包括STP、QoS、VLAN、端口等相关配置

- LACP（Link Aggregation Control Protocol）链路聚合控制协议：为交换数据的设备提供一种标准的协商方式，供系统根据自身配置自动形成聚合链路并启动聚合链路收发数据。聚合链路形成后，负责维护链路状态，在聚合条件发生变化时，自动调整或解散链路聚合

##8、OSPF协议
- OSPF（Open Shortest Path First）时IETF组织开发的一个基于链路状态的内部网关协议（Interior Gateway Protocol。
- OSPF作为基于链路状态的协议，具有收敛快、路由无环、可扩展等优点，被广泛接受并使用
- AS（Autonomous System)：在OSPF协议中，一个自治系统（AS）是指使用同一种路由协议交换路由信息的一组路由器
- Router ID是用于在自治系统中唯一标识一台运行OSPF的路由器的32位证书，格式与IP地址是一样
- Cost，OSPF的开销值是一个16位无符号整数，范围1-65535
- OSPF区域；
	- BR：骨干路由
	- ABR：非骨干路由
	- ASBR：外部路由

###OSPF路由计算
- OSPF协议报文
	1. Hello 发现和维护邻居uguanxi
	2. Database Description 发送链路状态数据库摘要
	3. Link State Request 请求特定的链路状态信息
	4. Link State Update 发送详细的链路状态信息
	5. Link State Ack 发送确认报文

- 邻居（Neighbor）与邻接（Adjacency）
	- 一个路由会由邻居路由，但不一定邻接
- OSPF支持的网络类型及其对应的协议
	- PPP（点到点）
	- 广播型
	- NBMA（非广播多路访问
	- P点到多点

- DR与BDR
	- DR：designated router  指定路由器。
	- BDR：backup designated router  备份指定路由器。
	- DR与BDR不是人为指定的，而是由本网段中所有路由器共同选举出来的
	- Router Priority最大的路由器不一定是DR/BDR
	- 点到点、点到多点和虚连接的链路上，不需要选举DR/BDR

- 各网络类型的邻居邻接关系
	- P2P/P2MP：总是和邻居建立邻接关系
	- 广播/NBMA：DR/BDR总是和所有路由包括BDR/DR建立邻接关系；DROther只能与DR/BDR建立邻接关系

- 邻居关系建立过程
	- 1-way与2-way的区别：路由器收到的hello报文包含自己的Router DI就是2-way状态，如果没有包含就是1-way状态

- LSDB同步
	- 同步的LSDB是OSPF正确计算路径的基础，在邻接关系建立的同时，OSPF路由器完成与邻接路由器的LSDB同步
	- 邻接关系建立和LSDB同步之后，LSA的更新存在两种形式
		- 周期性更新
		- 触发更新

##test

	[错]交换机支持 802.1Q 协议，它最多支持 4098 个 VLAN
	
	从整个 Internet 的观点出发，如何有效的减少路由表的规模？B
	
	   A  划分 VLAN
	   B  路由聚合
	   C  使用路由过滤策略
	   D  增加动态路由的更新频率
	
	OSPF 和 IS-IS 有很多相似之处，在 OSPF 中骨干区域用 area 0 表示，IS-IS 骨干区域的 Area 号是多少？A
	
	   A  没有特定的骨干区域
	   B  Area 49
	   C  Area 1
	   D  Area 0
	
	某 Trunk 端口允许 VLAN 3/4 /5 通过，但只有 VLAN3/4 报文是带 tag 的，vlan5 的报文不带 tag, 原因可能是什么？B
	
	   A  这个端口的 PVID 为 3 和 4
	   B  这个端口的 PVID 为 5
	   C  在配置 Trunk 端口时设置了 “port trunk permit vlan 3 4 “，但是不包括 VLAN5
	   D  在该端口上使能了 GVRP

	(多选题) 以下关于 MPLS 体系结构的说法正确的有哪些？
	
	   A  对于 LER，在转发平面只需要进行标签分组的转发
	   B  MPLS 使用短而定长的标签封装分组，在转发平面实现快速转发。在控制平面，MPLS 拥有 IP 网络强大灵活的路由功能，可以满足各种新应用对网络的要求
	   C  控制平面（Control Plane）之间基于无连接服务，利用现有 IP 网络实现
	   D  转发平面（Forwarding Plane）也称为数据平面（Data Plane），是面向连接的，可以使用 ATM、帧中继等二层网络
	   E  对于核心 LSR，在转发平面不仅需要进行标签分组的转发，也需要进行 IP 分组的转发，前者使用标签转发表 LFIB，后者使用传统转发表 FIB